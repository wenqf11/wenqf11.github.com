<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>CentOS 上双网卡双 IP 配置，实现内网访问外网 - Vince&#39;s Blog</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta itemprop="name" content="CentOS 上双网卡双 IP 配置，实现内网访问外网">
<meta itemprop="description" content="前两天配置了一台 CentOS 7 的服务器双网卡双IP，一个内网IP，一个外网IP。这样为这台服务器配置转发规则，内网网段的所有机器都可以通过它作为网关转发来上网了。"><meta itemprop="datePublished" content="2016-12-09T22:09:22&#43;00:00" />
<meta itemprop="dateModified" content="2016-12-09T22:09:22&#43;00:00" />
<meta itemprop="wordCount" content="936">
<meta itemprop="keywords" content="" /><meta property="og:title" content="CentOS 上双网卡双 IP 配置，实现内网访问外网" />
<meta property="og:description" content="前两天配置了一台 CentOS 7 的服务器双网卡双IP，一个内网IP，一个外网IP。这样为这台服务器配置转发规则，内网网段的所有机器都可以通过它作为网关转发来上网了。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://wenqingfu.me/post/config-two-network-interfaces/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2016-12-09T22:09:22&#43;00:00" />
<meta property="article:modified_time" content="2016-12-09T22:09:22&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CentOS 上双网卡双 IP 配置，实现内网访问外网"/>
<meta name="twitter:description" content="前两天配置了一台 CentOS 7 的服务器双网卡双IP，一个内网IP，一个外网IP。这样为这台服务器配置转发规则，内网网段的所有机器都可以通过它作为网关转发来上网了。"/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://wenqingfu.mecss/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://wenqingfu.mecss/main.css" />

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="https://wenqingfu.mecss/dark.css" />

	
		<script src="https://wenqingfu.mejs/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="https://wenqingfu.me">Vince&#39;s Blog</a></h1>
	<div class="site-description"><p>淡泊明志，宁静致远</p><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/post/">Posts</a>
			</li>
			
			<li>
				<a href="/categories/">Categories</a>
			</li>
			
			<li>
				<a href="/tags/">Tags</a>
			</li>
			
			<li>
				<a href="/about/">About</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">09</span>
							<span class="rest">Dec 2016</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">CentOS 上双网卡双 IP 配置，实现内网访问外网</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>前两天配置了一台 CentOS 7 的服务器双网卡双IP，一个内网IP，一个外网IP。这样为这台服务器配置转发规则，内网网段的所有机器都可以通过它作为网关转发来上网了。</p>
<h3 id="配置双网卡ip">配置双网卡IP</h3>
<p>首先需要做的是确保双网卡都能正常工作并且已经开启，这里可以使用 ifconfig 来查看网卡工作状态。确保有两块网卡正常工作，然后就可以去 /etc/sysconfig/network-scripts/ 目录下配置每块网卡的 IP 了。</p>
<p>该机器的外网 IP 配置为 166.111.80.x，网关为 166.111.80.gate，子网掩码255.255.255.0；内网IP配置为 192.168.3.y，网关为 192.168.3.gate，子网掩码255.255.255.0。</p>
<pre><code>vim /etc/sysconfig/network-scripts/ifcfg-eth0
</code></pre><pre><code>HWADDR=A0:42:3F:32:F0:5C
TYPE=Ethernet
BOOTPROTO=static
DEFROUTE=yes 
ONBOOT=yes   #开机自启动
IPADDR=166.111.80.x  #外网IP
PREFIX=24  #子网掩码为255.255.255.0
GATEWAY=166.111.80.gate  #网关
DNS1=166.111.8.28 #根据设置自己的DNS设置
</code></pre><p>保存后配置内网IP</p>
<pre><code>vim /etc/sysconfig/network-scripts/ifcfg-eth1
</code></pre><pre><code>HWADDR=A0:42:3F:32:F0:5D
TYPE=Ethernet
BOOTPROTO=static
DEFROUTE=yes 
ONBOOT=yes   #开机自启动
IPADDR=192.168.3.y  #内网IP
PREFIX=24  #子网掩码为255.255.255.0
#GATEWAY=192.168.3.gate  #注意：内网网卡网关不要填写或者注释掉，否则两个网卡同时启用后上不了外网
DNS1=166.111.8.28 #根据设置自己的DNS设置
</code></pre><h3 id="配置双网关路由表">配置双网关路由表</h3>
<p>目前系统默认网关是外网网关，内网IP是不能正常访问的，需要增加两个路由表，实现双网关正常访问。</p>
<pre><code>vim /etc/iproute2/rt_tables
</code></pre><p>增加如下内容：</p>
<pre><code>252  net2
251  net3
</code></pre><p>修改 /etc/rc.local，动添加静态路由规则，让网络请求哪里进来的，就从哪里出去。</p>
<pre><code>ip route flush table net2
ip route add default via 166.111.80.gate dev eth0 src 166.111.80.x table net2
ip rule add from 166.111.80.x table net2

ip route flush table net3
ip route add default via 192.168.3.gate dev eth1 src 192.168.3.y table net3
ip rule add from 192.168.3.y table net3
</code></pre><p>这样，双网卡双IP应该就配置好了，重启网络服务检测一下。在内网用内网IP访问，在外网用外网IP访问应该可以正常连接。</p>
<pre><code>service network restart
</code></pre><h3 id="配置转发规则">配置转发规则</h3>
<p>添加SNAT 规则，POSTROUTING 经过路由的源地址为192.168.3.0/24包把源地址改变为166.111.80.x。</p>
<pre><code>iptables -t nat -A POSTROUTING -s 192.168.3.0/24 -j SNAT --to-source 166.111.80.x
iptables -A FORWARD -s 192.168.3.0/24 -j ACCEPT
iptables -A FORWARD -d 192.168.3.0/24 -j ACCEPT
service iptables save
</code></pre><p>然后重启重启防火墙。</p>
<pre><code>service iptables restart
</code></pre><p>为了防止别人修改，可以把上述指令写入到 /etc/rc.local，每次开机启动时会重新执行。 
此外，还要打开 Linux 内核转发功能，使Linux内核的IP层能够数据转发。直接修改 /etc/sysctl.conf 增加 net.ipv4.ip_forward=1 或者直接执行下面指令：</p>
<pre><code>sysctl net.ipv4.ip_forward=1
</code></pre><p>重启一下网络服务</p>
<pre><code>service network restart
</code></pre><h3 id="配置内网机器访问外网">配置内网机器访问外网</h3>
<p>将内网某台机器的网关设置为 192.168.3.y，重启网络服务，应该就可以正常访问外网了。</p>
<h3 id="参考资料">参考资料</h3>
<p><a href="https://mr21.cc/network-technology/centos-two-gateway-configration.html">https://mr21.cc/network-technology/centos-two-gateway-configration.html</a>
<a href="https://my.oschina.net/wellben/blog/75358">https://my.oschina.net/wellben/blog/75358</a>
<a href="http://chopper.blog.51cto.com/3946170/1175724">http://chopper.blog.51cto.com/3946170/1175724</a>
<a href="http://www.lshell.com/2015/08/iptables-nat.html">http://www.lshell.com/2015/08/iptables-nat.html</a>
<a href="http://www.cnblogs.com/Qing-840/p/5501533.html">http://www.cnblogs.com/Qing-840/p/5501533.html</a></p>
			</div>

			<div class="tags">
				
					
				
			</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'spf13';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the </a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2021  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'Your tracking code', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>
</html>
